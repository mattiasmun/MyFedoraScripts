#!/usr/bin/env python3
import os
from pathlib import Path
import re

def keep_last_unique_bash_history(input_file, output_file):
    """
    Rensar dubbletter och svartlistade kommandon i Bash-historik.
    Hanterar tidsstämplar och sorterar resultatet alfabetiskt.
    """
    # Svartlista: Kommandon som börjar med dessa ord kommer att rensas bort.
    # Motsvarar din HISTIGNORE: ls, exit, history, pwd, clear 
    blacklist = ['ls', 'exit', 'history', 'pwd', 'clear']
    
    try:
        with open(input_file, 'r', errors='replace') as f_in:
            lines = f_in.readlines()
    except FileNotFoundError:
        print(f"Error: Input file '{input_file}' not found.")
        return

    unique_commands = {}
    i = 0
    while i < len(lines):
        line = lines[i].strip()
        
        # Kontrollera om raden är en tidsstämpel (#123456789)
        if line.startswith('#') and i + 1 < len(lines):
            timestamp = line + "\n"
            command = lines[i+1]
            cmd_text = command.strip()
            
            # Kolla om kommandot börjar med något i svartlistan
            first_word = cmd_text.split()[0] if cmd_text else ""
            if first_word not in blacklist:
                # Spara/ersätt: senaste förekomsten vinner
                unique_commands[cmd_text] = (timestamp, command)
            
            i += 2
        else:
            # Hantera rader utan tidsstämpel
            if line:
                first_word = line.split()[0]
                if first_word not in blacklist:
                    unique_commands[line] = (None, line + "\n")
            i += 1

    # Sortera alfabetiskt (case-insensitive)
    sorted_items = sorted(unique_commands.items(), key=lambda item: item[0].lower())

    try:
        with open(output_file, 'w') as f_out:
            for _, (ts, cmd) in sorted_items:
                if ts:
                    f_out.write(ts)
                f_out.write(cmd)
        print(f"Klar! Unika kommandon sparade till '{output_file}'")
        print("Använd nu Meld för att jämföra filerna.")

    except Exception as e:
        print(f"Ett fel uppstod vid skrivning: {e}")

_home = Path.home()
input_filename = _home / ".bash_history"
output_filename = _home / ".bash_history_cleaned"

keep_last_unique_bash_history(input_filename, output_filename)
