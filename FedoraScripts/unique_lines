#!/usr/bin/env python3
import os
from pathlib import Path

def keep_last_unique_bash_history(input_file, output_file):
    try:
        with open(input_file, 'r') as f_in:
            lines = f_in.readlines()
    except FileNotFoundError:
        print(f"Error: Input file '{input_file}' not found.")
        return

    unique_commands = {}
    i = 0
    while i < len(lines):
        line = lines[i]

        # Kolla om raden är en tidsstämpel (börjar med #)
        if line.startswith('#') and i + 1 < len(lines):
            timestamp = line
            command = lines[i+1]
            # Spara/ersätt med det senaste tidsstämplade kommandot
            unique_commands[command.strip()] = (timestamp, command)
            i += 2
        else:
            # Hantera rader som saknar tidsstämpel
            if line.strip():
                unique_commands[line.strip()] = (None, line)
            i += 1

    # Sortera alfabetiskt baserat på kommandot (inte tidsstämpeln)
    sorted_items = sorted(unique_commands.items(), key=lambda item: item[0].lower())

    try:
        with open(output_file, 'w') as f_out:
            for cmd_strip, (timestamp, full_command) in sorted_items:
                if timestamp:
                    f_out.write(timestamp)
                f_out.write(full_command)
        print(f"Historik städad och sparad till '{output_file}'")
    except Exception as e:
        print(f"Ett fel uppstod: {e}")

_home = Path.home()
input_filename = _home / ".bash_history"
output_filename = _home / ".bash_history_cleaned"

keep_last_unique_bash_history(input_filename, output_filename)
