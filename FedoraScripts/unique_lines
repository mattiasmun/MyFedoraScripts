#!/usr/bin/env python3
import os
from pathlib import Path

def keep_last_unique_bash_history(input_file, output_file):
    """
    Rensar dubbletter i Bash-historik med tidsstämplar.
    Behåller den senaste förekomsten och sorterar alfabetiskt.
    """
    try:
        with open(input_file, 'r', errors='replace') as f_in:
            lines = f_in.readlines()
    except FileNotFoundError:
        print(f"Error: Input file '{input_file}' not found.")
        return

    unique_commands = {}
    i = 0
    while i < len(lines):
        line = lines[i].strip()
        
        # Bash-historik lagrar tidsstämplar på rader som börjar med #
        if line.startswith('#') and i + 1 < len(lines):
            timestamp = line + "\n"
            command = lines[i+1]
            # Vi använder kommandot som nyckel för att få bort dubbletter.
            # Den senaste förekomsten i filen kommer skriva över tidigare.
            unique_commands[command.strip()] = (timestamp, command)
            i += 2
        else:
            # Hanterar rader utan tidsstämplar (om sådana finns)
            if line:
                unique_commands[line] = (None, line + "\n")
            i += 1

    # Sorterar alfabetiskt baserat på själva kommandot (skiftlägesoberoende)
    sorted_commands = sorted(unique_commands.items(), key=lambda item: item[0].lower())

    try:
        with open(output_file, 'w') as f_out:
            for _, (ts, cmd) in sorted_commands:
                if ts:
                    f_out.write(ts)
                f_out.write(cmd)
        print(f"Klar! Unika kommandon sparade till '{output_file}'")
        print("Använd nu Meld för att jämföra filerna.")

    except Exception as e:
        print(f"Ett fel uppstod vid skrivning: {e}")

_home = Path.home()
input_filename = _home / ".bash_history"
output_filename = _home / ".bash_history_cleaned"

keep_last_unique_bash_history(input_filename, output_filename)
