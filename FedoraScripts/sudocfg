#!/bin/bash

# Define the path to the executable we need
ASKPASS_PATH="/usr/libexec/gcr-ssh-askpass"

# Define the line to be added
ASKPASS_LINE="export SSH_ASKPASS=\"$ASKPASS_PATH\""

# Define the target file
BASHRC_FILE="$HOME/.bashrc"

# Check if the required executable exists. If not, attempt to install it.
if [ ! -f "$ASKPASS_PATH" ]; then
    echo "The required executable '$ASKPASS_PATH' was not found."
    echo "Attempting to install the gcr3 package using dnf..."
    
    # Use sudo to install the package non-interactively
    sudo dnf install gcr3 -y
    
    # After the installation attempt, check again if the file exists
    if [ ! -f "$ASKPASS_PATH" ]; then
        echo "Installation failed or the package does not provide the executable. Please install it manually and try again."
        exit 1
    else
        echo "Installation successful."
    fi
fi

# Check if the line already exists in the file
if grep -qF -- "$ASKPASS_LINE" "$BASHRC_FILE"; then
    echo "The line already exists in $BASHRC_FILE. No changes will be made."
else
    # Create a backup of the original file
    cp "$BASHRC_FILE" "${BASHRC_FILE}.bak"
    echo "Backup of $BASHRC_FILE created at ${BASHRC_FILE}.bak"

    # Append the line to the file
    echo "" >> "$BASHRC_FILE"
    echo "# Added by script to set the graphical ssh-askpass program" >> "$BASHRC_FILE"
    echo "$ASKPASS_LINE" >> "$BASHRC_FILE"
    
    echo "Successfully added the line to $BASHRC_FILE."
    echo "You need to restart your terminal or run 'source $BASHRC_FILE' to apply the changes."
fi

# Apply the changes to the current shell environment
echo "Sourcing $BASHRC_FILE to apply changes immediately."
source "$BASHRC_FILE"

exit 0
