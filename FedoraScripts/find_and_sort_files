#!/usr/bin/bash

# Kontrollera om en söksträng angavs
if [ -z "$1" ]; then
    echo "Användning: $0 <söksträng>"
    echo "Exempel: $0 logg (matchar 'logg', 'LOGG', 'Logg', etc. i filnamnet/sökvägen)"
    echo "         $0 .conf (matchar '.conf', '.CONF', '.Conf', etc. i filnamnet/sökvägen)"
    exit 1
fi

SEARCH_STRING_LOWER=$(echo "$1" | tr '[:upper:]' '[:lower:]') # Konvertera söksträngen till små bokstäver
START_PATH="." # Sök alltid från aktuell katalog

echo "Söker efter filer vars SÖKVÄG/FILNAMN innehåller '$1' (skiftlägesokänsligt), från '$START_PATH'…"

# Använd find för att hitta filer, filtrera sedan i while-loopen för filnamn/sökväg
# Spara resultatet i en temporär variabel för att kunna kontrollera antalet
FOUND_FILES=$(find "$START_PATH" -type f -print0 | \
    while IFS= read -r -d $'\0' filename; do
        filename_lower=$(echo "$filename" | tr '[:upper:]' '[:lower:]')
        if [[ "$filename_lower" == *"$SEARCH_STRING_LOWER"* ]]; then
            printf "%s\0" "$filename" # Skicka null-avgränsade filnamn vidare
        fi
    done)

# Kontrollera om inga filer hittades
if [ -z "$FOUND_FILES" ]; then
    echo "----------------------------------------------------"
    echo "Inga filer hittades som matchar söksträngen."
    exit 0
fi

echo "Sorterar efter storlek i fallande ordning:"
echo "----------------------------------------------------"

# Använd de funna filerna för att fortsätta pipelinen
echo -n "$FOUND_FILES" | \
    xargs -0 du -b | \
    sort -nr | \
    while read -r size_bytes filename; do
        # Kör ls på det faktiska filnamnet för att få utdatan
        ls -ldh --time-style=+%Y-%m-%d\ %H:%M:%S "$filename" | \
            awk '{
                # ls -l utdata: permissions, links, owner, group, size, month, day, time, filename
                # $5 = size (human readable)
                # $6, $7, $8 = date/time (formatted)
                
                # För att få korrekt filnamn som kan hantera mellanslag:
                file_start_col = 9;
                for (i = file_start_col; i <= NF; i++) {
                    if (i == file_start_col) { filename_part = $i; }
                    else { filename_part = filename_part " " $i; }
                }
                print $5, $6, $7, $8, filename_part
            }'
    done
