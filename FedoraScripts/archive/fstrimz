#!/bin/bash

# ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯
# This script performs a manual trim of mounted filesystems.
# It is designed to be used with a systemd timer for periodic execution.
#
# The script logs its actions to the system journal for easy debugging.
# ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯

# Exit immediately if a command exits with a non-zero status.
set -e

# Define a log function for consistent output to the system journal.
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | systemd-cat -t fstrimz
}

# ⎯⎯ Step 1: Execute fstrim with --fstab option ⎯⎯
log "Starting fstrim on all mounted filesystems listed in /etc/fstab…"

# Use the 'fstrim' command with the '--fstab' flag to trim all filesystems
# that are mounted and support the discard operation.
# The '--verbose' option will output what is being trimmed.
if /usr/sbin/fstrim --fstab --verbose; then
    log "fstrim completed successfully."
else
    # The command failed. Log the error and exit with a non-zero status.
    log "Error: fstrim failed. Please check the system journal for details."
    exit 1
fi

