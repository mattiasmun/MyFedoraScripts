#!/bin/bash

# Define the output file path
target_script_path="$HOME"'/Bash/MyFedoraScripts/FedoraScripts/progs'

# 1. Start writing the new script file
echo '#!/bin/bash' > "$target_script_path"

# Define the command prefix
install_command_prefix='sudo -A dnf -y install '

# 2. Query user-installed packages, then pipe the result to grep -vE
# dnf5 repoquery outputs one package per line.
# grep -vE:
#   -v: Invert the match (output lines that *DO NOT* match the pattern)
#   -E: Enable extended regex for the '|' (OR) operator
# The pattern excludes any line containing 'kmod-VirtualBox-' OR 'kmod-nvidia-'.
package_query_result="$(dnf5 repoquery --userinstalled --queryformat '%{name}.%{arch} \\n' | grep -vE 'kmod-(VirtualBox|nvidia)-')"

# 3. Remove the final trailing space and backslash added by the queryformat
# The trimming logic should now leave a trailing backslash in the 'package_query_result' variable,
# which allows the final 'dnf install' command to continue gracefully.
package_query_result="${package_query_result::-2}"

# 4. Write the final command to the file
echo "$install_command_prefix$package_query_result" >> "$target_script_path"

# 5. Make the new file executable
chmod +x "$target_script_path"
